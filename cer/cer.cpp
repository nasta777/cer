// chess_game.cpp
// Убедитесь, что в настройках проекта установлен "Use Unicode Character Set"

#include <windows.h>
#include <vector>
#include <string>
#include <algorithm> // Для std::copy
#include <cmath>     // Для abs
#include <chrono>    // Для таймера
#include <iomanip>   // Для std::put_time, std::setw
#include <sstream>   // Для std::wstringstream

#include <mmsystem.h> // Для PlaySound
#pragma comment(lib, "winmm.lib") // Линкуем библиотеку для звука

// --- Глобальные переменные и константы ---
const wchar_t* APP_TITLE_BASE = L"Шахматы на C++ (Unicode)";
std::wstring currentAppTitle = APP_TITLE_BASE;
const wchar_t* CLASS_NAME = L"ChessWindowClass";

const int BOARD_SIZE = 8;
const int CELL_SIZE = 70;
const int BOARD_DISPLAY_WIDTH = BOARD_SIZE * CELL_SIZE;
const int BOARD_DISPLAY_HEIGHT = BOARD_SIZE * CELL_SIZE;

const int CAPTURED_AREA_WIDTH = CELL_SIZE * 3;
const int TOTAL_WINDOW_WIDTH = BOARD_DISPLAY_WIDTH + CAPTURED_AREA_WIDTH;
const int TOTAL_WINDOW_HEIGHT = BOARD_DISPLAY_HEIGHT;


// Состояние игры
wchar_t board[BOARD_SIZE][BOARD_SIZE];
bool isWhiteTurn = true;
int selectedRow = -1, selectedCol = -1;
bool gameOver = false;
std::wstring gameStatusMessage = L"";

// --- Unicode символы фигур ---
const wchar_t W_KING = L'\u2654'; const wchar_t B_KING = L'\u265A';
const wchar_t W_QUEEN = L'\u2655'; const wchar_t B_QUEEN = L'\u265B';
const wchar_t W_ROOK = L'\u2656'; const wchar_t B_ROOK = L'\u265C';
const wchar_t W_BISHOP = L'\u2657'; const wchar_t B_BISHOP = L'\u265D';
const wchar_t W_KNIGHT = L'\u2658'; const wchar_t B_KNIGHT = L'\u265E';
const wchar_t W_PAWN = L'\u2659'; const wchar_t B_PAWN = L'\u265F';
const wchar_t EMPTY_CELL = L' ';

// --- Состояния для продвинутой логики ---
bool whiteKingMoved = false; bool blackKingMoved = false;
bool whiteRookA1Moved = false; bool whiteRookH1Moved = false;
bool blackRookA8Moved = false; bool blackRookH8Moved = false;
int enPassantTargetCol = -1; int enPassantTargetRow = -1;
bool canEnPassant = false;
bool awaitingPawnPromotion = false;
int promotionRow = -1, promotionCol = -1;

struct Move {
    int fromR, fromC, toR, toC;
    bool isCastlingKingSide = false; bool isCastlingQueenSide = false;
    bool isEnPassant = false; wchar_t promotionPiece = EMPTY_CELL;
    Move(int fr, int fc, int tr, int tc, wchar_t promo = EMPTY_CELL)
        : fromR(fr), fromC(fc), toR(tr), toC(tc), isCastlingKingSide(false), isCastlingQueenSide(false), isEnPassant(false), promotionPiece(promo) {
    }
    Move(bool kingSideCastling, bool whiteMove)
        : isCastlingKingSide(kingSideCastling), isCastlingQueenSide(!kingSideCastling), isEnPassant(false), promotionPiece(EMPTY_CELL) {
        fromR = whiteMove ? 7 : 0; fromC = 4; toR = fromR; toC = kingSideCastling ? 6 : 2;
    }
    Move(int fr, int fc, int tr, int tc, bool enPassantMove)
        : fromR(fr), fromC(fc), toR(tr), toC(tc), isCastlingKingSide(false), isCastlingQueenSide(false), isEnPassant(enPassantMove), promotionPiece(EMPTY_CELL) {
    }
    bool operator==(const Move& other) const {
        return fromR == other.fromR && fromC == other.fromC && toR == other.toR && toC == other.toC &&
            isCastlingKingSide == other.isCastlingKingSide && isCastlingQueenSide == other.isCastlingQueenSide &&
            isEnPassant == other.isEnPassant && promotionPiece == other.promotionPiece;
    }
};
std::vector<Move> availableMoves;

// --- Для отображения съеденных фигур ---
std::vector<wchar_t> capturedByWhite;
std::vector<wchar_t> capturedByBlack;

// --- Для таймера ---
std::chrono::steady_clock::time_point gameStartTime;
std::chrono::duration<double> elapsedGameTime;
const UINT_PTR IDT_GAMETIMER = 1;

// --- Для звуков (замените на пути к вашим файлам) ---
const wchar_t* SOUND_GAME_START = L"game_start.wav";       // Звук начала новой игры
const wchar_t* SOUND_MOVE_PIECE = L"move.wav";           // Звук обычного хода фигуры (без взятия, без шаха)
const wchar_t* SOUND_CAPTURE_PIECE = L"capture.wav";       // Звук взятия фигуры (если это не привело к шаху/мату)
const wchar_t* SOUND_CHECK = L"check.wav";               // Звук объявления шаха королю
const wchar_t* SOUND_CASTLING = L"castling.wav";         // Звук рокировки
const wchar_t* SOUND_PROMOTION = L"promotion.wav";       // Звук, когда пешка достигла поля превращения и ожидается выбор
const wchar_t* SOUND_GAME_END_MATE = L"mate.wav";          // Звук мата (победа)
const wchar_t* SOUND_GAME_END_STALEMATE = L"stalemate.wav"; // Звук пата (ничья)
const wchar_t* SOUND_ERROR_MOVE = L"error_move.wav";     // Звук при попытке нелегального хода

// --- Прототипы функций ---
void InitializeBoard(HWND hwnd);
void DrawChessBoardItself(HDC hdc);
void DrawCapturedPiecesPanel(HDC hdc);
void PlayGameSound(const wchar_t* soundFileName);
bool IsPieceWhite(wchar_t piece); bool IsPieceBlack(wchar_t piece);
bool IsPathClear(int r1, int c1, int r2, int c2, const wchar_t currentBoard[BOARD_SIZE][BOARD_SIZE]);
bool FindKing(wchar_t kingToFind, const wchar_t currentBoard[BOARD_SIZE][BOARD_SIZE], int& kingR, int& kingC);
bool CanPieceLegallyAttackSquare(wchar_t piece, int fromR, int fromC, int toR, int toC, const wchar_t currentBoard[BOARD_SIZE][BOARD_SIZE]);
bool IsSquareAttacked(int r, int c, bool byWhiteAttacker, const wchar_t currentBoard[BOARD_SIZE][BOARD_SIZE]);
bool IsKingInCheck(bool whiteKingToCheck, const wchar_t currentBoard[BOARD_SIZE][BOARD_SIZE]);
bool IsPseudoLegalMove(const Move& move, const wchar_t currentBoard[BOARD_SIZE][BOARD_SIZE], bool turnIsWhite, int epCol, int epRow, bool canEP);
bool IsCastlingAllowed(bool kingSide, bool forWhite, const wchar_t cb[BOARD_SIZE][BOARD_SIZE], bool wkM, bool bkM, bool wrA1, bool wrH1, bool brA8, bool brH8);
bool IsMoveLegal(const Move& move, bool turnIsWhite, const wchar_t cb[BOARD_SIZE][BOARD_SIZE], int epCol, int epRow, bool canEP, bool wkM, bool bkM, bool wrA1, bool wrH1, bool brA8, bool brH8);
std::vector<Move> GenerateAllLegalMoves(bool forWhite, const wchar_t cb[BOARD_SIZE][BOARD_SIZE], int epCol, int epRow, bool canEP, bool wkM, bool bkM, bool wrA1M, bool wrH1M, bool brA8M, bool brH8M);
void HandleClick(HWND hwnd, int x, int y);
void UpdateWindowTitle(HWND hwnd);
LRESULT CALLBACK WindowProc(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam);


void PlayGameSound(const wchar_t* soundFileName) {
    PlaySound(soundFileName, NULL, SND_FILENAME | SND_ASYNC | SND_NODEFAULT);
}

// --- Инициализация ---
void InitializeBoard(HWND hwnd) {
    for (int r = 0; r < BOARD_SIZE; ++r) for (int c = 0; c < BOARD_SIZE; ++c) board[r][c] = EMPTY_CELL;
    board[0][0] = B_ROOK; board[0][1] = B_KNIGHT; board[0][2] = B_BISHOP; board[0][3] = B_QUEEN; board[0][4] = B_KING; board[0][5] = B_BISHOP; board[0][6] = B_KNIGHT; board[0][7] = B_ROOK;
    for (int c = 0; c < BOARD_SIZE; ++c) board[1][c] = B_PAWN;
    board[7][0] = W_ROOK; board[7][1] = W_KNIGHT; board[7][2] = W_BISHOP; board[7][3] = W_QUEEN; board[7][4] = W_KING; board[7][5] = W_BISHOP; board[7][6] = W_KNIGHT; board[7][7] = W_ROOK;
    for (int c = 0; c < BOARD_SIZE; ++c) board[6][c] = W_PAWN;

    isWhiteTurn = true; selectedRow = -1; selectedCol = -1; gameOver = false; gameStatusMessage = L"";
    whiteKingMoved = false; blackKingMoved = false; whiteRookA1Moved = false; whiteRookH1Moved = false; blackRookA8Moved = false; blackRookH8Moved = false;
    enPassantTargetCol = -1; enPassantTargetRow = -1; canEnPassant = false;
    awaitingPawnPromotion = false; promotionRow = -1; promotionCol = -1;
    availableMoves.clear();

    capturedByWhite.clear();
    capturedByBlack.clear();

    gameStartTime = std::chrono::steady_clock::now();
    elapsedGameTime = std::chrono::duration<double>(0);

    UpdateWindowTitle(hwnd);
    // PlayGameSound(SOUND_GAME_START); // Перенесено в WM_CREATE
}

bool IsPieceWhite(wchar_t piece) { /*...*/ return piece == W_KING || piece == W_QUEEN || piece == W_ROOK || piece == W_BISHOP || piece == W_KNIGHT || piece == W_PAWN; }
bool IsPieceBlack(wchar_t piece) { /*...*/ return piece == B_KING || piece == B_QUEEN || piece == B_ROOK || piece == B_BISHOP || piece == B_KNIGHT || piece == B_PAWN; }
bool IsPathClear(int r1, int c1, int r2, int c2, const wchar_t currentBoard[BOARD_SIZE][BOARD_SIZE]) { /*...*/ int dr = (r2 > r1) ? 1 : ((r2 < r1) ? -1 : 0); int dc = (c2 > c1) ? 1 : ((c2 < c1) ? -1 : 0); int r = r1 + dr; int c = c1 + dc; while (r != r2 || c != c2) { if (r < 0 || r >= BOARD_SIZE || c < 0 || c >= BOARD_SIZE)return false; if (currentBoard[r][c] != EMPTY_CELL)return false; r += dr;c += dc; } return true; }
bool FindKing(wchar_t kingToFind, const wchar_t currentBoard[BOARD_SIZE][BOARD_SIZE], int& kingR, int& kingC) { /*...*/ for (int r = 0;r < BOARD_SIZE;++r)for (int c = 0;c < BOARD_SIZE;++c)if (currentBoard[r][c] == kingToFind) { kingR = r;kingC = c;return true; } return false; }
bool CanPieceLegallyAttackSquare(wchar_t piece, int fromR, int fromC, int toR, int toC, const wchar_t currentBoard[BOARD_SIZE][BOARD_SIZE]) { /*...*/ if (fromR < 0 || fromR >= BOARD_SIZE || fromC < 0 || fromC >= BOARD_SIZE || toR < 0 || toR >= BOARD_SIZE || toC < 0 || toC >= BOARD_SIZE)return false; if (piece == EMPTY_CELL || (fromR == toR && fromC == toC))return false; int dr_abs = abs(toR - fromR); int dc_abs = abs(toC - fromC); switch (piece) { case W_PAWN: return(toR == fromR - 1 && (toC == fromC - 1 || toC == fromC + 1)); case B_PAWN: return(toR == fromR + 1 && (toC == fromC - 1 || toC == fromC + 1)); case W_ROOK: case B_ROOK: return(dr_abs == 0 || dc_abs == 0) && IsPathClear(fromR, fromC, toR, toC, currentBoard); case W_KNIGHT: case B_KNIGHT: return(dr_abs == 2 && dc_abs == 1) || (dr_abs == 1 && dc_abs == 2); case W_BISHOP: case B_BISHOP: return(dr_abs == dc_abs) && IsPathClear(fromR, fromC, toR, toC, currentBoard); case W_QUEEN: case B_QUEEN: return(dr_abs == 0 || dc_abs == 0 || dr_abs == dc_abs) && IsPathClear(fromR, fromC, toR, toC, currentBoard); case W_KING: case B_KING: return(dr_abs <= 1 && dc_abs <= 1); } return false; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               bool IsSquareAttacked(int r, int c, bool byWhiteAttacker, const wchar_t currentBoard[BOARD_SIZE][BOARD_SIZE]) { /*...*/ for (int R = 0;R < BOARD_SIZE;++R)for (int C = 0;C < BOARD_SIZE;++C) { wchar_t attacker = currentBoard[R][C]; if (attacker == EMPTY_CELL)continue; if ((byWhiteAttacker && IsPieceWhite(attacker)) || (!byWhiteAttacker && IsPieceBlack(attacker))) { if (CanPieceLegallyAttackSquare(attacker, R, C, r, c, currentBoard))return true; } } return false; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               bool IsKingInCheck(bool whiteKingToCheck, const wchar_t currentBoard[BOARD_SIZE][BOARD_SIZE]) { /*...*/ wchar_t king = whiteKingToCheck ? W_KING : B_KING; int kr, kc; if (!FindKing(king, currentBoard, kr, kc))return false; return IsSquareAttacked(kr, kc, !whiteKingToCheck, currentBoard); }
bool IsPseudoLegalMove(const Move& move, const wchar_t cb[BOARD_SIZE][BOARD_SIZE], bool turnW, int epC, int epR, bool canEP) { int fr = move.fromR, fc = move.fromC, tr = move.toR, tc = move.toC; if (fr < 0 || fr >= BOARD_SIZE || fc < 0 || fc >= BOARD_SIZE || tr < 0 || tr >= BOARD_SIZE || tc < 0 || tc >= BOARD_SIZE || (fr == tr && fc == tc))return false; wchar_t p = cb[fr][fc], tP = cb[tr][tc]; if (p == EMPTY_CELL || (turnW && !IsPieceWhite(p)) || (!turnW && !IsPieceBlack(p)))return false; if (tP != EMPTY_CELL && ((IsPieceWhite(p) && IsPieceWhite(tP)) || (IsPieceBlack(p) && IsPieceBlack(tP))))return false; int drA = abs(tr - fr), dcA = abs(tc - fc), drS = tr - fr; switch (p) { case W_PAWN: if (dcA == 0 && drS == -1 && tP == EMPTY_CELL)return true; if (dcA == 0 && drS == -2 && fr == 6 && tP == EMPTY_CELL && cb[fr - 1][fc] == EMPTY_CELL)return true; if (dcA == 1 && drS == -1 && tP != EMPTY_CELL && IsPieceBlack(tP))return true; if (move.isEnPassant)return canEP && fr == 3 && dcA == 1 && drS == -1 && tr == epR && tc == epC && tP == EMPTY_CELL && cb[fr][epC] == B_PAWN; return false; case B_PAWN: if (dcA == 0 && drS == 1 && tP == EMPTY_CELL)return true; if (dcA == 0 && drS == 2 && fr == 1 && tP == EMPTY_CELL && cb[fr + 1][fc] == EMPTY_CELL)return true; if (dcA == 1 && drS == 1 && tP != EMPTY_CELL && IsPieceWhite(tP))return true; if (move.isEnPassant)return canEP && fr == 4 && dcA == 1 && drS == 1 && tr == epR && tc == epC && tP == EMPTY_CELL && cb[fr][epC] == W_PAWN; return false; case W_ROOK: case B_ROOK: return(drA == 0 || dcA == 0) && IsPathClear(fr, fc, tr, tc, cb); case W_KNIGHT: case B_KNIGHT: return(drA == 2 && dcA == 1) || (drA == 1 && dcA == 2); case W_BISHOP: case B_BISHOP: return(drA == dcA) && IsPathClear(fr, fc, tr, tc, cb); case W_QUEEN: case B_QUEEN: return(drA == 0 || dcA == 0 || drA == dcA) && IsPathClear(fr, fc, tr, tc, cb); case W_KING: case B_KING: return drA <= 1 && dcA <= 1; } return false; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        bool IsCastlingAllowed(bool kingSide, bool forWhite, const wchar_t cb[BOARD_SIZE][BOARD_SIZE], bool wkM, bool bkM, bool wrA1, bool wrH1, bool brA8, bool brH8) { if (IsKingInCheck(forWhite, cb))return false; int r = forWhite ? 7 : 0; if (forWhite) { if (wkM)return false; if (kingSide) { if (wrH1 || cb[r][5] != EMPTY_CELL || cb[r][6] != EMPTY_CELL || IsSquareAttacked(r, 5, false, cb) || IsSquareAttacked(r, 6, false, cb))return false; } else { if (wrA1 || cb[r][1] != EMPTY_CELL || cb[r][2] != EMPTY_CELL || cb[r][3] != EMPTY_CELL || IsSquareAttacked(r, 2, false, cb) || IsSquareAttacked(r, 3, false, cb))return false; } } else { if (bkM)return false; if (kingSide) { if (brH8 || cb[r][5] != EMPTY_CELL || cb[r][6] != EMPTY_CELL || IsSquareAttacked(r, 5, true, cb) || IsSquareAttacked(r, 6, true, cb))return false; } else { if (brA8 || cb[r][1] != EMPTY_CELL || cb[r][2] != EMPTY_CELL || cb[r][3] != EMPTY_CELL || IsSquareAttacked(r, 2, true, cb) || IsSquareAttacked(r, 3, true, cb))return false; } } return true; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        bool IsMoveLegal(const Move& move, bool turnW, const wchar_t curB[BOARD_SIZE][BOARD_SIZE], int epC, int epR, bool canEP, bool wkM, bool bkM, bool wrA1, bool wrH1, bool brA8, bool brH8) { if (move.isCastlingKingSide || move.isCastlingQueenSide)return IsCastlingAllowed(move.isCastlingKingSide, turnW, curB, wkM, bkM, wrA1, wrH1, brA8, brH8); if (!IsPseudoLegalMove(move, curB, turnW, epC, epR, canEP))return false; wchar_t tempB[BOARD_SIZE][BOARD_SIZE] = {}; std::copy(&curB[0][0], &curB[0][0] + BOARD_SIZE * BOARD_SIZE, &tempB[0][0]); tempB[move.toR][move.toC] = tempB[move.fromR][move.fromC]; tempB[move.fromR][move.fromC] = EMPTY_CELL; if (move.isEnPassant) { if (turnW)tempB[move.toR + 1][move.toC] = EMPTY_CELL;else tempB[move.toR - 1][move.toC] = EMPTY_CELL; } if (move.promotionPiece != EMPTY_CELL)tempB[move.toR][move.toC] = move.promotionPiece; if (IsKingInCheck(turnW, tempB))return false; return true; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        std::vector<Move> GenerateAllLegalMoves(bool forW, const wchar_t curB[BOARD_SIZE][BOARD_SIZE], int epC, int epR, bool canEP, bool wkM, bool bkM, bool wrA1M, bool wrH1M, bool brA8M, bool brH8M) { std::vector<Move> legalMs; wchar_t p; for (int r = 0;r < BOARD_SIZE;++r)for (int c = 0;c < BOARD_SIZE;++c) { p = curB[r][c]; if (p == EMPTY_CELL || (forW && !IsPieceWhite(p)) || (!forW && !IsPieceBlack(p)))continue; for (int tr = 0;tr < BOARD_SIZE;++tr)for (int tc = 0;tc < BOARD_SIZE;++tc) { if ((p == W_PAWN && r == 1 && tr == 0) || (p == B_PAWN && r == 6 && tr == 7)) { wchar_t promos[] = { forW ? W_QUEEN : B_QUEEN,forW ? W_ROOK : B_ROOK,forW ? W_BISHOP : B_BISHOP,forW ? W_KNIGHT : B_KNIGHT }; for (wchar_t promo : promos) { Move potM(r, c, tr, tc, promo); if (IsMoveLegal(potM, forW, curB, epC, epR, canEP, wkM, bkM, wrA1M, wrH1M, brA8M, brH8M))legalMs.push_back(potM); } } else { Move potM(r, c, tr, tc); if ((p == W_PAWN || p == B_PAWN) && abs(c - tc) == 1 && curB[tr][tc] == EMPTY_CELL && tr == epR && tc == epC && canEP)potM.isEnPassant = true; if (IsMoveLegal(potM, forW, curB, epC, epR, canEP, wkM, bkM, wrA1M, wrH1M, brA8M, brH8M))legalMs.push_back(potM); } } } int kR = forW ? 7 : 0; wchar_t kP = forW ? W_KING : B_KING; if (curB[kR][4] == kP) { Move cKS(true, forW); if (IsMoveLegal(cKS, forW, curB, epC, epR, canEP, wkM, bkM, wrA1M, wrH1M, brA8M, brH8M))legalMs.push_back(cKS); Move cQS(false, forW); if (IsMoveLegal(cQS, forW, curB, epC, epR, canEP, wkM, bkM, wrA1M, wrH1M, brA8M, brH8M))legalMs.push_back(cQS); } return legalMs; }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        void HandleClick(HWND hwnd, int x, int y) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (awaitingPawnPromotion) return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (gameOver) return; // Исправлено: убрана проверка wParam, т.к. его здесь нет


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            int c_clicked = x / CELL_SIZE;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            int r_clicked = y / CELL_SIZE;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (r_clicked < 0 || r_clicked >= BOARD_SIZE || c_clicked < 0 || c_clicked >= BOARD_SIZE) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (selectedRow != -1) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    selectedRow = -1; selectedCol = -1;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    availableMoves.clear();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    InvalidateRect(hwnd, NULL, TRUE);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            wchar_t clickedPiece = board[r_clicked][c_clicked];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            bool pieceCapturedDuringMove = false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            bool nextPlayerKingInCheck = false;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (selectedRow == -1) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (clickedPiece != EMPTY_CELL && ((isWhiteTurn && IsPieceWhite(clickedPiece)) || (!isWhiteTurn && IsPieceBlack(clickedPiece)))) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    selectedRow = r_clicked; selectedCol = c_clicked;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    availableMoves.clear();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    std::vector<Move> allMoves = GenerateAllLegalMoves(isWhiteTurn, board, enPassantTargetCol, enPassantTargetRow, canEnPassant, whiteKingMoved, blackKingMoved, whiteRookA1Moved, whiteRookH1Moved, blackRookA8Moved, blackRookH8Moved);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for (const auto& m : allMoves) if (m.fromR == selectedRow && m.fromC == selectedCol) availableMoves.push_back(m);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Move currentAttemptedMove(selectedRow, selectedCol, r_clicked, c_clicked);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                wchar_t pieceToMove = board[selectedRow][selectedCol];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                wchar_t pieceOnTargetSquare = board[r_clicked][c_clicked];

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if ((pieceToMove == W_PAWN || pieceToMove == B_PAWN) && abs(selectedCol - c_clicked) == 1 && pieceOnTargetSquare == EMPTY_CELL && r_clicked == enPassantTargetRow && c_clicked == enPassantTargetCol && canEnPassant) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    currentAttemptedMove.isEnPassant = true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                else if ((pieceToMove == W_KING || pieceToMove == B_KING) && abs(selectedCol - c_clicked) == 2 && selectedRow == r_clicked) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    currentAttemptedMove.isCastlingKingSide = (c_clicked > selectedCol); currentAttemptedMove.isCastlingQueenSide = (c_clicked < selectedCol);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (IsMoveLegal(currentAttemptedMove, isWhiteTurn, board, enPassantTargetCol, enPassantTargetRow, canEnPassant, whiteKingMoved, blackKingMoved, whiteRookA1Moved, whiteRookH1Moved, blackRookA8Moved, blackRookH8Moved)) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    wchar_t movedPiece = board[selectedRow][selectedCol];

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (pieceOnTargetSquare != EMPTY_CELL) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (IsPieceWhite(pieceOnTargetSquare)) capturedByBlack.push_back(pieceOnTargetSquare);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        else capturedByWhite.push_back(pieceOnTargetSquare);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        pieceCapturedDuringMove = true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (currentAttemptedMove.isEnPassant) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (isWhiteTurn) capturedByWhite.push_back(B_PAWN);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        else capturedByBlack.push_back(W_PAWN);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        pieceCapturedDuringMove = true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    canEnPassant = false;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (movedPiece == W_KING) whiteKingMoved = true; else if (movedPiece == B_KING) blackKingMoved = true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    else if (movedPiece == W_ROOK) { if (selectedRow == 7 && selectedCol == 0)whiteRookA1Moved = true; else if (selectedRow == 7 && selectedCol == 7)whiteRookH1Moved = true; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    else if (movedPiece == B_ROOK) { if (selectedRow == 0 && selectedCol == 0)blackRookA8Moved = true; else if (selectedRow == 0 && selectedCol == 7)blackRookH8Moved = true; }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    board[r_clicked][c_clicked] = movedPiece; board[selectedRow][selectedCol] = EMPTY_CELL;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (currentAttemptedMove.isCastlingKingSide) { if (isWhiteTurn) { board[7][5] = board[7][7]; board[7][7] = EMPTY_CELL; whiteRookH1Moved = true; } else { board[0][5] = board[0][7];board[0][7] = EMPTY_CELL; blackRookH8Moved = true; } }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    else if (currentAttemptedMove.isCastlingQueenSide) { if (isWhiteTurn) { board[7][3] = board[7][0]; board[7][0] = EMPTY_CELL; whiteRookA1Moved = true; } else { board[0][3] = board[0][0];board[0][0] = EMPTY_CELL; blackRookA8Moved = true; } }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (currentAttemptedMove.isEnPassant) { if (isWhiteTurn) board[r_clicked + 1][c_clicked] = EMPTY_CELL; else board[r_clicked - 1][c_clicked] = EMPTY_CELL; }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (movedPiece == W_PAWN && selectedRow == 6 && r_clicked == 4) { enPassantTargetCol = c_clicked; enPassantTargetRow = 5; canEnPassant = true; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    else if (movedPiece == B_PAWN && selectedRow == 1 && r_clicked == 3) { enPassantTargetCol = c_clicked; enPassantTargetRow = 2; canEnPassant = true; }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if ((movedPiece == W_PAWN && r_clicked == 0) || (movedPiece == B_PAWN && r_clicked == BOARD_SIZE - 1)) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        awaitingPawnPromotion = true; promotionRow = r_clicked; promotionCol = c_clicked;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        gameStatusMessage = L"Выберите фигуру: Q, R, B, K (Knight)";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Звук SOUND_PROMOTION будет сыгран в общем блоке звуков ниже
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (!awaitingPawnPromotion) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        isWhiteTurn = !isWhiteTurn;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        gameStatusMessage = L"";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        std::vector<Move> nextPlayerLegalMoves = GenerateAllLegalMoves(isWhiteTurn, board, enPassantTargetCol, enPassantTargetRow, canEnPassant, whiteKingMoved, blackKingMoved, whiteRookA1Moved, whiteRookH1Moved, blackRookA8Moved, blackRookH8Moved);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        nextPlayerKingInCheck = IsKingInCheck(isWhiteTurn, board);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (nextPlayerKingInCheck) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (nextPlayerLegalMoves.empty()) { gameStatusMessage = L"МАТ!"; gameOver = true; elapsedGameTime = std::chrono::steady_clock::now() - gameStartTime; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else { gameStatusMessage = L"ШАХ!"; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (nextPlayerLegalMoves.empty()) { gameStatusMessage = L"ПАТ!"; gameOver = true; elapsedGameTime = std::chrono::steady_clock::now() - gameStartTime; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Общая логика звуков после хода
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (gameOver) { // Эта проверка должна быть первой
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (gameStatusMessage == L"МАТ!") PlayGameSound(SOUND_GAME_END_MATE);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        else if (gameStatusMessage == L"ПАТ!") PlayGameSound(SOUND_GAME_END_STALEMATE);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    else if (awaitingPawnPromotion) { // Если ожидаем превращения
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        PlayGameSound(SOUND_PROMOTION); // Звук ожидания выбора фигуры
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    else if (nextPlayerKingInCheck) { // Шах для следующего игрока (и не конец игры, и не промо)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        PlayGameSound(SOUND_CHECK);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    else if (currentAttemptedMove.isCastlingKingSide || currentAttemptedMove.isCastlingQueenSide) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        PlayGameSound(SOUND_CASTLING);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    else if (pieceCapturedDuringMove) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        PlayGameSound(SOUND_CAPTURE_PIECE);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        PlayGameSound(SOUND_MOVE_PIECE);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    selectedRow = -1; selectedCol = -1; availableMoves.clear();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    UpdateWindowTitle(hwnd);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                else if (clickedPiece != EMPTY_CELL && ((isWhiteTurn && IsPieceWhite(clickedPiece)) || (!isWhiteTurn && IsPieceBlack(clickedPiece)))) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    selectedRow = r_clicked; selectedCol = c_clicked;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    availableMoves.clear();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    std::vector<Move> allMoves = GenerateAllLegalMoves(isWhiteTurn, board, enPassantTargetCol, enPassantTargetRow, canEnPassant, whiteKingMoved, blackKingMoved, whiteRookA1Moved, whiteRookH1Moved, blackRookA8Moved, blackRookH8Moved);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for (const auto& m : allMoves) if (m.fromR == selectedRow && m.fromC == selectedCol) availableMoves.push_back(m);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (selectedRow != -1) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        PlayGameSound(SOUND_ERROR_MOVE);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    selectedRow = -1; selectedCol = -1; availableMoves.clear();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            InvalidateRect(hwnd, NULL, TRUE);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // --- Отрисовка ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        void DrawChessBoardItself(HDC hdc) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            HFONT hPieceFont = CreateFont(CELL_SIZE - 15, 0, 0, 0, FW_NORMAL, FALSE, FALSE, FALSE, DEFAULT_CHARSET, OUT_DEFAULT_PRECIS, CLIP_DEFAULT_PRECIS, CLEARTYPE_QUALITY, DEFAULT_PITCH | FF_DONTCARE, L"Segoe UI Symbol");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            HFONT hOldFont = (HFONT)SelectObject(hdc, hPieceFont);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            SetTextAlign(hdc, TA_CENTER | TA_BASELINE); SetBkMode(hdc, TRANSPARENT);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            for (int r = 0; r < BOARD_SIZE; ++r) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for (int c = 0; c < BOARD_SIZE; ++c) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    RECT cellRect = { c * CELL_SIZE, r * CELL_SIZE, (c + 1) * CELL_SIZE, (r + 1) * CELL_SIZE };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    HBRUSH hBrush = CreateSolidBrush(((r + c) % 2 == 0) ? RGB(240, 217, 181) : RGB(181, 136, 99));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    FillRect(hdc, &cellRect, hBrush); DeleteObject(hBrush);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (r == selectedRow && c == selectedCol && !awaitingPawnPromotion) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        HBRUSH hHighlight = CreateSolidBrush(RGB(100, 200, 100)); FrameRect(hdc, &cellRect, hHighlight); DeleteObject(hHighlight);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (selectedRow != -1 && !awaitingPawnPromotion) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for (const auto& move : availableMoves) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (move.toR == r && move.toC == c) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                HGDIOBJ origBrush = GetCurrentObject(hdc, OBJ_BRUSH);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                HBRUSH hAvailBrush = CreateSolidBrush((board[r][c] != EMPTY_CELL || move.isEnPassant) ? RGB(255, 100, 100) : RGB(144, 238, 144));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                SelectObject(hdc, hAvailBrush);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Ellipse(hdc, cellRect.left + CELL_SIZE / 3, cellRect.top + CELL_SIZE / 3, cellRect.right - CELL_SIZE / 3, cellRect.bottom - CELL_SIZE / 3);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                SelectObject(hdc, origBrush); DeleteObject(hAvailBrush);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (board[r][c] != EMPTY_CELL) TextOutW(hdc, cellRect.left + CELL_SIZE / 2, cellRect.top + CELL_SIZE / 2 + (CELL_SIZE - 15) / 3 + 2, &board[r][c], 1);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            SelectObject(hdc, hOldFont); DeleteObject(hPieceFont);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        void DrawCapturedPiecesPanel(HDC hdc) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            RECT panelRect = { BOARD_DISPLAY_WIDTH, 0, TOTAL_WINDOW_WIDTH, TOTAL_WINDOW_HEIGHT };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            FillRect(hdc, &panelRect, (HBRUSH)GetStockObject(LTGRAY_BRUSH));

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            HFONT hLabelFont = CreateFont(CELL_SIZE / 3, 0, 0, 0, FW_NORMAL, FALSE, FALSE, FALSE, DEFAULT_CHARSET, OUT_DEFAULT_PRECIS, CLIP_DEFAULT_PRECIS, DEFAULT_QUALITY, DEFAULT_PITCH | FF_DONTCARE, L"Arial");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            HFONT hCapturedPieceFont = CreateFont(CELL_SIZE / 2, 0, 0, 0, FW_NORMAL, FALSE, FALSE, FALSE, DEFAULT_CHARSET, OUT_DEFAULT_PRECIS, CLIP_DEFAULT_PRECIS, CLEARTYPE_QUALITY, DEFAULT_PITCH | FF_DONTCARE, L"Segoe UI Symbol");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            HFONT hOldFont = (HFONT)SelectObject(hdc, hLabelFont);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            SetBkMode(hdc, TRANSPARENT);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            SetTextColor(hdc, RGB(0, 0, 0));

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            int currentY = 10;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            int startX = BOARD_DISPLAY_WIDTH + 10;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            int pieceSpacing = CELL_SIZE / 2;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            /*TextOutW(hdc, startX, currentY, L"Съедено белыми:", static_cast<int>(wcslen(L"Съедено белыми:")));*/
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            currentY += CELL_SIZE / 2;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            SelectObject(hdc, hCapturedPieceFont);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            for (size_t i = 0; i < capturedByWhite.size(); ++i) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                TextOutW(hdc, startX + (static_cast<int>(i) % 4) * pieceSpacing, currentY + (static_cast<int>(i) / 4) * pieceSpacing, &capturedByWhite[i], 1);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            int rowsForWhiteCaptured = 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (!capturedByWhite.empty()) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                rowsForWhiteCaptured = (static_cast<int>(capturedByWhite.size() - 1) / 4) + 1;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                currentY += rowsForWhiteCaptured * pieceSpacing;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                currentY += pieceSpacing;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            currentY += CELL_SIZE / 3;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            SelectObject(hdc, hLabelFont);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            /*TextOutW(hdc, startX, currentY, L"Съедено черными:", static_cast<int>(wcslen(L"Съедено черными:")));*/
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            currentY += CELL_SIZE / 2;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            SelectObject(hdc, hCapturedPieceFont);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            for (size_t i = 0; i < capturedByBlack.size(); ++i) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                TextOutW(hdc, startX + (static_cast<int>(i) % 4) * pieceSpacing, currentY + (static_cast<int>(i) / 4) * pieceSpacing, &capturedByBlack[i], 1);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            SelectObject(hdc, hOldFont);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            DeleteObject(hLabelFont);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            DeleteObject(hCapturedPieceFont);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        void UpdateWindowTitle(HWND hwnd) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            currentAppTitle = APP_TITLE_BASE;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            currentAppTitle += (isWhiteTurn ? L" - Ход Белых" : L" - Ход Черных");

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            std::chrono::duration<double> currentTimeOrFinal;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (gameOver) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                currentTimeOrFinal = elapsedGameTime;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                currentTimeOrFinal = std::chrono::steady_clock::now() - gameStartTime;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            long long totalSeconds = static_cast<long long>(currentTimeOrFinal.count());
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            long long hours = totalSeconds / 3600;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            long long minutes = (totalSeconds % 3600) / 60;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            long long seconds = totalSeconds % 60;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            std::wstringstream wss;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            wss << L" (Время: " << std::setw(2) << std::setfill(L'0') << hours << L":"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                << std::setw(2) << std::setfill(L'0') << minutes << L":"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                << std::setw(2) << std::setfill(L'0') << seconds << L")";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            currentAppTitle += wss.str();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (!gameStatusMessage.empty()) currentAppTitle += L" (" + gameStatusMessage + L")";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (gameOver) currentAppTitle += L" - ИГРА ОКОНЧЕНА";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            SetWindowTextW(hwnd, currentAppTitle.c_str());
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        LRESULT CALLBACK WindowProc(HWND hwnd, UINT uMsg, WPARAM wParam, LPARAM lParam) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            switch (uMsg) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            case WM_CREATE:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                InitializeBoard(hwnd);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                SetTimer(hwnd, IDT_GAMETIMER, 1000, NULL);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                PlayGameSound(SOUND_GAME_START);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                break;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            case WM_TIMER:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (wParam == IDT_GAMETIMER) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (!gameOver) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        UpdateWindowTitle(hwnd);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                break;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            case WM_PAINT: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                PAINTSTRUCT ps; HDC hdc = BeginPaint(hwnd, &ps);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                DrawChessBoardItself(hdc);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                DrawCapturedPiecesPanel(hdc);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                EndPaint(hwnd, &ps);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            case WM_LBUTTONDOWN: HandleClick(hwnd, LOWORD(lParam), HIWORD(lParam)); return 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            case WM_KEYDOWN:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (wParam == 'N' && !awaitingPawnPromotion) { InitializeBoard(hwnd); InvalidateRect(hwnd, NULL, TRUE); }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                else if (awaitingPawnPromotion && !gameOver) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    wchar_t promotedP = EMPTY_CELL; bool chosen = true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    switch (wParam) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    case 'Q': promotedP = isWhiteTurn ? W_QUEEN : B_QUEEN; break; case 'R': promotedP = isWhiteTurn ? W_ROOK : B_ROOK; break;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    case 'B': promotedP = isWhiteTurn ? W_BISHOP : B_BISHOP; break; case 'K': promotedP = isWhiteTurn ? W_KNIGHT : B_KNIGHT; break;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    default: chosen = false; break;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (chosen && promotedP != EMPTY_CELL) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        board[promotionRow][promotionCol] = promotedP; awaitingPawnPromotion = false;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        isWhiteTurn = !isWhiteTurn;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        gameStatusMessage = L"";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        std::vector<Move> nextPlayerLegalMoves = GenerateAllLegalMoves(isWhiteTurn, board, enPassantTargetCol, enPassantTargetRow, canEnPassant, whiteKingMoved, blackKingMoved, whiteRookA1Moved, whiteRookH1Moved, blackRookA8Moved, blackRookH8Moved);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        bool kingNowInCheck = IsKingInCheck(isWhiteTurn, board);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (kingNowInCheck) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (nextPlayerLegalMoves.empty()) { gameStatusMessage = L"МАТ!"; gameOver = true; elapsedGameTime = std::chrono::steady_clock::now() - gameStartTime; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else { gameStatusMessage = L"ШАХ!"; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (nextPlayerLegalMoves.empty()) { gameStatusMessage = L"ПАТ!"; gameOver = true; elapsedGameTime = std::chrono::steady_clock::now() - gameStartTime; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (gameOver) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (gameStatusMessage == L"МАТ!") PlayGameSound(SOUND_GAME_END_MATE);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else if (gameStatusMessage == L"ПАТ!") PlayGameSound(SOUND_GAME_END_STALEMATE);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        else if (kingNowInCheck) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            PlayGameSound(SOUND_CHECK);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        UpdateWindowTitle(hwnd); InvalidateRect(hwnd, NULL, TRUE);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                break;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            case WM_DESTROY:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                KillTimer(hwnd, IDT_GAMETIMER);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                PostQuitMessage(0); return 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return DefWindowProcW(hwnd, uMsg, wParam, lParam);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        int WINAPI wWinMain(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            _In_ HINSTANCE hInstance,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            _In_opt_ HINSTANCE hPrevInstance, // Добавил _In_opt_ для подавления некоторых анализаторов, но C28251 может остаться
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            _In_ PWSTR lpCmdLine,             // Добавил _In_
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            _In_ int nCmdShow) {

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            UNREFERENCED_PARAMETER(hPrevInstance); // Если не используются
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            UNREFERENCED_PARAMETER(lpCmdLine);    // Если не используются

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            WNDCLASSW wc = { 0 }; wc.lpfnWndProc = WindowProc; wc.hInstance = hInstance; wc.lpszClassName = CLASS_NAME;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            wc.hCursor = LoadCursor(NULL, IDC_ARROW);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            wc.hbrBackground = NULL;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (!RegisterClassW(&wc)) { MessageBoxW(NULL, L"Ошибка регистрации класса окна!", L"Ошибка", MB_ICONERROR); return 0; }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            RECT windowRect = { 0, 0, TOTAL_WINDOW_WIDTH, TOTAL_WINDOW_HEIGHT };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            AdjustWindowRectEx(&windowRect, (WS_OVERLAPPEDWINDOW & ~WS_THICKFRAME & ~WS_MAXIMIZEBOX) | WS_CLIPCHILDREN, FALSE, WS_EX_COMPOSITED);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            HWND hwnd = CreateWindowExW(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                WS_EX_COMPOSITED,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                CLASS_NAME, currentAppTitle.c_str(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                (WS_OVERLAPPEDWINDOW & ~WS_THICKFRAME & ~WS_MAXIMIZEBOX) | WS_CLIPCHILDREN,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                CW_USEDEFAULT, CW_USEDEFAULT, windowRect.right - windowRect.left, windowRect.bottom - windowRect.top,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                NULL, NULL, hInstance, NULL);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (hwnd == NULL) { MessageBoxW(NULL, L"Ошибка создания окна!", L"Ошибка", MB_ICONERROR); return 0; }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ShowWindow(hwnd, nCmdShow); UpdateWindow(hwnd);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            MSG msg = { 0 };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            while (GetMessageW(&msg, NULL, 0, 0) > 0) { TranslateMessage(&msg); DispatchMessageW(&msg); }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return (int)msg.wParam;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }